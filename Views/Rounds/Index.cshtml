@model IEnumerable<WaterTankerManager.Models.RoundEntry>

@{
    ViewData["Title"] = "Rounds";
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Rounds Management @(ViewBag.ShowHidden ? "(Hidden)" : "")</h2>
        <div class="d-flex align-items-center gap-3">
            @if (User.IsInRole("Admin"))
            {
                <!-- Hidden Toggle (Secondary Action) -->
                @if (ViewBag.ShowHidden)
                {
                     <a asp-action="Index" asp-route-showHidden="false" class="btn btn-warning rounded-pill px-3 shadow-sm d-flex align-items-center">
                        <i class="fa-solid fa-arrow-left me-2"></i> Active
                    </a>
                }
                else
                {
                     <a asp-action="Index" asp-route-showHidden="true" class="btn btn-light border rounded-pill px-3 shadow-sm text-secondary d-flex align-items-center hover-shadow">
                        <i class="fa-solid fa-box-archive me-2"></i> View Archives
                    </a>
                }

                <!-- Add New (Primary Action) -->
                <button type="button" class="btn btn-primary rounded-pill px-4 shadow-sm d-flex align-items-center" data-bs-toggle="modal" data-bs-target="#addRoundModal">
                    <i class="fa-solid fa-plus me-2"></i> New Round
                </button>
            }
        </div>
    </div>

    <div class="custom-table-container">
        <div class="table-responsive">
            <table class="custom-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Number of Rounds</th>
                        <th>Total Amount</th>
                        @if (User.IsInRole("Admin"))
                        {
                            <th>Actions</th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model) {
                        <tr class="@(item.IsHidden ? "table-secondary text-muted" : "")" id="row-@item.Id">
                            <td>@item.Date.ToShortDateString()</td>
                            <td>@item.NumberOfRounds</td>
                            <td class="text-success fw-bold">@item.TotalAmount.ToString("C")</td>
                            @if (User.IsInRole("Admin"))
                            {
                                <td>
                                    <!-- Toggle Hide Button -->
                                    <button type="button" class="btn-icon btn-icon-secondary me-2 toggle-hide-btn" 
                                            data-id="@item.Id" 
                                            title="@(item.IsHidden ? "Show" : "Hide")">
                                        <i class="fa-solid @(item.IsHidden ? "fa-eye" : "fa-eye-slash")"></i>
                                    </button>
                                    <!-- Edit Button -->
                                    <button type="button" class="btn-icon btn-icon-edit me-2 edit-btn" 
                                            data-id="@item.Id" 
                                            data-date="@item.Date.ToString("yyyy-MM-dd")" 
                                            data-rounds="@item.NumberOfRounds" 
                                            data-amount="@item.TotalAmount"
                                            title="Edit">
                                        <i class="fa-solid fa-pen-to-square"></i>
                                    </button>
                                    <!-- Delete Button -->
                                    <button type="button" class="btn-icon btn-icon-delete delete-btn" 
                                            data-id="@item.Id" 
                                            title="Delete">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </td>
                            }
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- ADD ROUND MODAL -->
<div class="modal fade" id="addRoundModal" tabindex="-1" aria-labelledby="addRoundModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="Create" method="post" id="addRoundForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="addRoundModalLabel">Add New Round</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="form-group mb-3">
                        <label for="AddDate" class="form-label">Date</label>
                        <input name="Date" type="date" class="form-control" id="AddDate" value="@DateTime.Now.ToString("yyyy-MM-dd")" />
                        <span id="AddDateError" class="validation-error">Date is required.</span>
                    </div>
                    <div class="form-group mb-3">
                        <label for="AddRounds" class="form-label">Number Of Rounds</label>
                        <input name="NumberOfRounds" type="number" class="form-control" id="AddRounds" placeholder="e.g. 5" />
                        <span id="AddRoundsError" class="validation-error">Please enter a valid number of rounds.</span>
                    </div>
                    <div class="form-group mb-3">
                        <label for="AddAmount" class="form-label">Total Amount</label>
                        <input name="TotalAmount" type="number" step="0.01" class="form-control" id="AddAmount" placeholder="e.g. 1500.00" />
                        <span id="AddAmountError" class="validation-error">Amount must be greater than 0.</span>
                    </div>
                    
                    <!-- Day Off Segmented Control -->
                    <div class="mb-4">
                        <label class="form-label fw-bold mb-2">Day Status</label>
                        <div class="segmented-control">
                            <input type="radio" name="IsOffDay" value="false" id="AddTypeWorking" class="segmented-input" checked onchange="toggleRoundInputs(this, 'add')">
                            <label class="segmented-label" for="AddTypeWorking">
                                <i class="fa-solid fa-briefcase"></i> Working Day
                            </label>

                            <input type="radio" name="IsOffDay" value="true" id="AddTypeOff" class="segmented-input" onchange="toggleRoundInputs(this, 'add')">
                            <label class="segmented-label" for="AddTypeOff">
                                <i class="fa-solid fa-mug-hot"></i> Off Day
                            </label>
                        </div>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary" onclick="return validateAddRound()">Save changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- EDIT ROUND MODAL -->
<div class="modal fade" id="editRoundModal" tabindex="-1" aria-labelledby="editRoundModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="Edit" method="post" id="editRoundForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="editRoundModalLabel">Edit Round</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="Id" id="EditId" />
                    <div class="form-group mb-3">
                        <label for="EditDate" class="form-label">Date</label>
                        <input name="Date" type="date" class="form-control" id="EditDate" />
                        <span id="EditDateError" class="validation-error">Date is required.</span>
                    </div>
                    <div class="form-group mb-3">
                        <label for="EditRounds" class="form-label">Number Of Rounds</label>
                        <input name="NumberOfRounds" type="number" class="form-control" id="EditRounds" />
                        <span id="EditRoundsError" class="validation-error">Please enter a valid number of rounds.</span>
                    </div>
                    <div class="form-group mb-3">
                        <label for="EditAmount" class="form-label">Total Amount</label>
                        <input name="TotalAmount" type="number" step="0.01" class="form-control" id="EditAmount" />
                        <span id="EditAmountError" class="validation-error">Amount must be greater than 0.</span>
                    </div>

                    <!-- Day Off Segmented Control (Edit) -->
                    <div class="mb-4">
                        <label class="form-label fw-bold mb-2">Day Status</label>
                        <div class="segmented-control">
                            <input type="radio" name="IsOffDay" value="false" id="EditTypeWorking" class="segmented-input" onchange="toggleRoundInputs(this, 'edit')">
                            <label class="segmented-label" for="EditTypeWorking">
                                <i class="fa-solid fa-briefcase"></i> Working Day
                            </label>

                            <input type="radio" name="IsOffDay" value="true" id="EditTypeOff" class="segmented-input" onchange="toggleRoundInputs(this, 'edit')">
                            <label class="segmented-label" for="EditTypeOff">
                                <i class="fa-solid fa-mug-hot"></i> Off Day
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary" onclick="return validateEditRound()">Update Round</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- DELETE CONFIRMATION MODAL -->
<div class="modal fade" id="deleteRoundModal" tabindex="-1" aria-labelledby="deleteRoundModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger" id="deleteRoundModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this round entry?
            </div>
            <div class="modal-footer">
                <form asp-action="Delete" method="post">
                    <input type="hidden" name="id" id="DeleteId" />
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Yes, Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Handle Toggle Hide Button Click
            $('.toggle-hide-btn').click(function () {
                var btn = $(this);
                var id = btn.data('id');
                var row = $('#row-' + id);
                var isHidden = btn.data('current-hidden') === 'True'; 

                Swal.fire({
                    title: 'Toggle Visibility?',
                    text: "This round will vanish from the current list!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Yes, change it!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.post('/Rounds/ToggleStatus/' + id, function (response) {
                            if (response.success) {
                                Swal.fire('Updated!', 'Round visibility has been changed.', 'success');
                                row.fadeOut(300, function() { $(this).remove(); });
                            } else {
                                Swal.fire('Error!', 'Failed to update status.', 'error');
                            }
                        }).fail(function () {
                            Swal.fire('Error!', 'Error communicating with server.', 'error');
                        });
                    }
                });
            });

            // Handle Edit Button Click
            $('.edit-btn').click(function () {
                var id = $(this).data('id');
                var date = $(this).data('date');
                var rounds = $(this).data('rounds');
                var amount = $(this).data('amount');
                var isOffDay = $(this).data('isoffday') === 'True';

                $('#EditId').val(id);
                $('#EditDate').val(date);
                $('#EditRounds').val(rounds);
                $('#EditAmount').val(amount);
                
                // Set Radio Buttons and Trigger UI/Logic update
                if(isOffDay) {
                    $('#EditTypeOff').prop('checked', true).trigger('change');
                } else {
                    $('#EditTypeWorking').prop('checked', true).trigger('change');
                }

                // Clear validation errors
                $('.validation-error').hide();
                $('.form-control').removeClass('is-invalid');

                var editModal = new bootstrap.Modal(document.getElementById('editRoundModal'));
                editModal.show();
            });

            // Handle Delete Button Click
            $('.delete-btn').click(function () {
                var id = $(this).data('id');
                $('#DeleteId').val(id);
                var deleteModal = new bootstrap.Modal(document.getElementById('deleteRoundModal'));
                deleteModal.show();
            });

            // Clear errors on Add modal open
            var addModal = document.getElementById('addRoundModal');
            addModal.addEventListener('show.bs.modal', function () {
                $('.validation-error').hide();
                $('.form-control').removeClass('is-invalid');
                $('#addRoundForm')[0].reset();
                $('#AddDate').val(new Date().toISOString().split('T')[0]);
                
                // Reset to Working Day
                $('#AddTypeWorking').prop('checked', true).trigger('change');
            });
        });

        // Toggle Inputs Logic
        function toggleRoundInputs(radio, mode) {
            var isOffDay = $(radio).val() === 'true';
            var prefix = mode === 'add' ? '#Add' : '#Edit';
            
            var roundsInput = $(prefix + 'Rounds');
            var amountInput = $(prefix + 'Amount');

            if (isOffDay) {
                // Freeze inputs
                roundsInput.addClass('input-frozen').prop('readonly', true).val('0');
                amountInput.addClass('input-frozen').prop('readonly', true).val('0.00');
                
                // Clear any validation errors immediately
                roundsInput.removeClass('is-invalid');
                amountInput.removeClass('is-invalid');
                $(prefix + 'RoundsError').hide();
                $(prefix + 'AmountError').hide();
            } else {
                // Unfreeze inputs
                roundsInput.removeClass('input-frozen').prop('readonly', false);
                amountInput.removeClass('input-frozen').prop('readonly', false);
                
                if(roundsInput.val() == '0') roundsInput.val('');
                if(amountInput.val() == '0.00' || amountInput.val() == '0') amountInput.val('');
            }
        }

        function validateAddRound() {
            var isValid = true;
            var isOffDay = $('input[name="IsOffDay"]:checked', '#addRoundForm').val() === 'true';

            // Date Validation
            var date = $('#AddDate').val();
            if (!date) {
                $('#AddDate').addClass('is-invalid');
                $('#AddDateError').show();
                isValid = false;
            } else {
                $('#AddDate').removeClass('is-invalid');
                $('#AddDateError').hide();
            }

            // Skip other validations if it's an Off Day
            if (!isOffDay) {
                // Rounds Validation
                var rounds = $('#AddRounds').val();
                if (!rounds || rounds <= 0) {
                    $('#AddRounds').addClass('is-invalid');
                    $('#AddRoundsError').show();
                    isValid = false;
                } else {
                    $('#AddRounds').removeClass('is-invalid');
                    $('#AddRoundsError').hide();
                }

                // Amount Validation
                var amount = $('#AddAmount').val();
                if (!amount || amount <= 0) {
                    $('#AddAmount').addClass('is-invalid');
                    $('#AddAmountError').show();
                    isValid = false;
                } else {
                    $('#AddAmount').removeClass('is-invalid');
                    $('#AddAmountError').hide();
                }
            } else {
                // Ensure values are set to 0 for submission
                $('#AddRounds').val('0');
                $('#AddAmount').val('0');
            }

            return isValid;
        }

        function validateEditRound() {
            var isValid = true;
            var isOffDay = $('input[name="IsOffDay"]:checked', '#editRoundForm').val() === 'true';

            // Date
            var date = $('#EditDate').val();
            if (!date) {
                $('#EditDate').addClass('is-invalid');
                $('#EditDateError').show();
                isValid = false;
            } else {
                $('#EditDate').removeClass('is-invalid');
                $('#EditDateError').hide();
            }

            if (!isOffDay) {
                // Rounds
                var rounds = $('#EditRounds').val();
                if (!rounds || rounds <= 0) {
                    $('#EditRounds').addClass('is-invalid');
                    $('#EditRoundsError').show();
                    isValid = false;
                } else {
                    $('#EditRounds').removeClass('is-invalid');
                    $('#EditRoundsError').hide();
                }

                // Amount
                var amount = $('#EditAmount').val();
                if (!amount || amount <= 0) {
                    $('#EditAmount').addClass('is-invalid');
                    $('#EditAmountError').show();
                    isValid = false;
                } else {
                    $('#EditAmount').removeClass('is-invalid');
                    $('#EditAmountError').hide();
                }
            } else {
                $('#EditRounds').val('0');
                $('#EditAmount').val('0');
            }

            return isValid;
        }
    </script>
}
